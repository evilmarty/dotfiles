#!/bin/bash

main() {
  local last_revision=$(git rev-parse HEAD)
  local last_exit_status=0

  while [ git-is-dirty ]; do
    git commit --patch "$@"
    local last_exit_status=$?
    if [ $last_exit_status -ne 0 ]; then
      break
    fi
  done

  local current_revision=$(git rev-parse HEAD)
  if [ "$last_revision" == "$current_revision" ]; then
    return $last_exit_status
  fi
}

git-branch-guard --branch master --confirm && main "$@"

